<div class="add-product-modal">
  <button igxButton="raised" color="primary" (click)="openAddProductModal()">
    <i class="fas fa-plus"></i>
    Add New Product
  </button>
</div>
<div class="product-management-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading products...</p>
  </div>

  <div *ngIf="errorMessage" class="error-container">
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      {{ errorMessage }}
    </div>
    <button class="retry-btn" (click)="loadProducts()" *ngIf="!isLoading">
      <i class="fas fa-redo"></i>
      Retry
    </button>
  </div>
  <div *ngIf="successMessage" class="success-container">
    <div class="success-message">
      <i class="fas fa-check-circle"></i>
      {{ successMessage }}
    </div>
  </div>
  <div *ngIf="isUpdating" class="updating-container">
    <div class="updating-message">
      <i class="fas fa-spinner fa-spin"></i>
      Updating quantity...
    </div>
  </div>
  <div *ngIf="!isLoading && !errorMessage" class="grid-container">
    <igx-grid
      #grid
      [data]="product"
      class="data"
      *ngIf="product.length > 0"
      [height]="'500px'"
      [width]="'100%'"
      [autoGenerate]="false"
      (cellEditDone)="onCellEditDone($event)"
      (columnResized)="(true)"
    >
      <igx-column [editable]="false">
        <ng-template igxCell let-cell="cell">
          <button igxButton="raised" color="danger" (click)="deleteProduct(cell.row.data.product_id)">Delete</button>
        </ng-template>
      </igx-column>

      <igx-column
        field="product_id"
        header="product ID"
        dataType="string"
        width="200px"
      ></igx-column>
      <igx-column
        field="name"
        header="Product Name"
        dataType="string"
        width="250px"
        [editable]="true"
        resizable="true"
      ></igx-column>
      <igx-column
        field="categories.name"
        header="Category"
        dataType="string"
        width="200px"
      ></igx-column>
      <igx-column field="brand_name" header="Brand" width="100px" [editable]="true">
        <ng-template igxCellEditor let-cell="cell">
          <igx-select #brandSelect [(ngModel)]="cell.editValue" (opened)="brandSelect.open()">
            {{ cell.value }}
            <igx-select-item *ngFor="let b of brands" [value]="b.name">
              {{ b.name }}
            </igx-select-item>
          </igx-select>
        </ng-template>
      </igx-column>
      <igx-column field="price" header="Price" dataType="number" width="150px">
        <ng-template igxCell let-cell="cell">
          {{ formatToCurrency(cell.value * 1000) }}
        </ng-template>
      </igx-column>

      <igx-column
        field="quantity"
        header="Quantity"
        dataType="number"
        width="150px"
        [editable]="true"
      ></igx-column>
      <igx-column field="created_at" header="Created At" dataType="string" width="200px">
        <ng-template igxCell let-cell="cell">
          {{ cell.value | date : 'dd/MM/yyyy' }}
        </ng-template>
      </igx-column>
      <igx-column field="updated_at" header="Updated At" dataType="string" width="200px">
        <ng-template igxCell let-cell="cell">
          {{ cell.value | date : 'dd/MM/yyyy' }}
        </ng-template>
      </igx-column>
    </igx-grid>

    <!-- Empty State -->
    <div *ngIf="product.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <h3>No products Found</h3>
      <p>You don't have any products yet. products containing your products will appear here.</p>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add New Product</h2>
      <span class="close" (click)="closeAddProductModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form class="add-product-form">
        <div class="form-group">
          <label for="productName">Product Name *</label>
          <input
            type="text"
            id="productName"
            [(ngModel)]="newProduct.name"
            name="productName"
            placeholder="Enter product name"
            required>
        </div>

        <div class="form-group">
          <label for="productPrice">Price (VND) *</label>
          <input
            type="number"
            id="productPrice"
            [(ngModel)]="newProduct.price"
            name="productPrice"
            placeholder="Enter price"
            min="0"
            required>
        </div>

        <div class="form-group">
          <label for="productQuantity">Quantity *</label>
          <input
            type="number"
            id="productQuantity"
            [(ngModel)]="newProduct.quantity"
            name="productQuantity"
            placeholder="Enter quantity"
            min="0"
            required>
        </div>

        <div class="form-group">
          <label for="productBrand">Brand *</label>
          <select
            id="productBrand"
            [(ngModel)]="newProduct.brand_id"
            name="productBrand"
            required>
            <option value="">Select a brand</option>
            <option *ngFor="let brand of brands" [value]="brand.brand_id">
              {{ brand.name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="productCategory">Category</label>
          <select
            id="productCategory"
            [(ngModel)]="newProduct.category_id"
            name="productCategory">
            <option value="">Select a category</option>
            <option *ngFor="let category of categories" [value]="category.category_id">
              {{ category.name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="productSize">Size (ml)</label>
          <input
            type="number"
            id="productSize"
            [(ngModel)]="newProduct.size_ml"
            name="productSize"
            placeholder="Enter size in ml"
            min="0">
        </div>

        <div class="form-group">
          <label for="productDiscount">Discount (%)</label>
          <input
            type="number"
            id="productDiscount"
            [(ngModel)]="newProduct.discount"
            name="productDiscount"
            placeholder="Enter discount percentage"
            min="0"
            max="100">
        </div>

        <div class="form-group">
          <label for="productDescription">Description</label>
          <textarea
            id="productDescription"
            [(ngModel)]="newProduct.description"
            name="productDescription"
            placeholder="Enter product description"
            rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="productImage">Product Image</label>
          <input
            type="file"
            id="productImage"
            (change)="onImageSelected($event)"
            name="productImage"
            accept="image/*"
            class="file-input">
          <div class="image-preview" *ngIf="imagePreview">
            <img [src]="imagePreview" alt="Preview" class="preview-img">
            <button type="button" class="remove-image" (click)="removeImage()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="file-input-info" *ngIf="!imagePreview">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to select image or drag and drop</p>
            <small>Supported formats: JPG, PNG, GIF (Max 5MB)</small>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeAddProductModal()">Cancel</button>
      <button
        type="button"
        class="btn-save"
        (click)="addProduct()"
        [disabled]="isAddingProduct || !isFormValid()">
        <i class="fas fa-spinner fa-spin" *ngIf="isAddingProduct"></i>
        {{ isAddingProduct ? 'Adding...' : 'Add Product' }}
      </button>
    </div>
  </div>
</div>
